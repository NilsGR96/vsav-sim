<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸš’ Simulation dÃ©part VSAV</title>

<style>
body{
    font-family: Arial;
    background:#0f172a;
    color:white;
    text-align:center;
    padding:20px;
}

button{
    border:none;
    border-radius:12px;
    padding:16px;
    font-size:22px;
    margin:10px;
    width:90%;
    max-width:350px;
}

#dispatchBtn{background:#e11d48;color:white;}
#examBtn{background:#fb923c;color:white;}
#routeBtn{background:#8b5cf6;color:white;}
#mapBtn{background:#22c55e;color:white;display:none;}
#answerBtn{background:#3b82f6;color:white;display:none;}

#result{font-size:32px;margin-top:20px}
#timer{font-size:40px;color:#facc15;margin-top:20px}

#loadingBox{
    width:90%;
    max-width:400px;
    height:25px;
    background:#1e293b;
    border-radius:20px;
    margin:20px auto;
    overflow:hidden;
    display:none;
}
#loadingBar{
    height:100%;
    width:0%;
    background:#22c55e;
}
</style>
</head>

<body>

<h1>ðŸš’ Simulation dÃ©part</h1>

<div id="loadingText"></div>
<div id="loadingBox"><div id="loadingBar"></div></div>

<select id="timeSelect">
<option value="0">Pas de chrono</option>
<option value="10">10 sec</option>
<option value="20">20 sec</option>
<option value="30">30 sec</option>
</select>

<br>

<button id="dispatchBtn" disabled onclick="dispatch()">Ã‡A DÃ‰CALE ðŸš¨</button>
<button id="examBtn" disabled onclick="dispatchExam()">Ã‡A PART DIRECT ðŸš¨</button>
<button id="routeBtn" disabled onclick="dispatchRoute()">JE PARS / JE VAIS ðŸ§­</button>

<div id="timer"></div>
<div id="result"></div>

<div>
<button id="mapBtn" onclick="openMap()">Afficher sur la carte</button>
<button id="answerBtn" onclick="showAnswer()">Afficher la ville</button>
</div>

<div onclick="showEasterEgg()" style="position:fixed;bottom:10px;left:10px;font-size:12px;cursor:pointer">ðŸ‘€</div>
<div onclick="localStorage.clear();alert('Cache vidÃ© ðŸ‘ recharge la page');" style="position:fixed;bottom:10px;right:10px;font-size:12px;cursor:pointer">reset cache</div>

<script>
let streetsByCity={}
let currentAddress=""
let hiddenCity=""
let routeMode=false
let startAddress=""
let endAddress=""

// stockage local
function saveStreetsToLocal(){
 localStorage.setItem("streetsData",JSON.stringify(streetsByCity))
}
function loadStreetsFromLocal(){
 const data=localStorage.getItem("streetsData")
 if(data){ streetsByCity=JSON.parse(data); return true }
 return false
}

function updateLoading(progress,text){
 loadingText.innerHTML=text
 loadingBox.style.display="block"
 loadingBar.style.width=progress+"%"
}

async function fetchCity(city,progress){
 updateLoading(progress,"TÃ©lÃ©chargement rues : "+city+"...")
 const query=`[out:json];area["name"="${city}"]["admin_level"="8"]->.a;(way["highway"]["name"](area.a););out tags;`
 const res=await fetch("https://overpass-api.de/api/interpreter",{method:"POST",body:query})
 const data=await res.json()

 const streets=[...new Set(data.elements.map(e=>e.tags.name)
  .filter(n=>n&&(n.startsWith("Rue")||n.startsWith("Avenue")||n.startsWith("Boulevard")))
  .map(name=>({city,name})))]

 streetsByCity[city]=streets
}

async function init(){
 if(loadStreetsFromLocal()){
  loadingText.innerHTML="Rues chargÃ©es depuis le tÃ©lÃ©phone ðŸš€"
  enableButtons()
  return
 }

 await fetchCity("Sarcelles",30)
 await fetchCity("Villiers-le-Bel",60)
 await fetchCity("Ã‰couen",90)

 updateLoading(100,"Sauvegarde locale...")
 saveStreetsToLocal()

 setTimeout(()=>{
  loadingBox.style.display="none"
  loadingText.innerHTML="Rues prÃªtes ðŸš’"
  enableButtons()
 },800)
}
init()

function enableButtons(){
 dispatchBtn.disabled=false
 examBtn.disabled=false
 routeBtn.disabled=false
}

function getRandomStreet(){
 const cities=Object.keys(streetsByCity)
 const city=cities[Math.floor(Math.random()*cities.length)]
 const street=streetsByCity[city][Math.floor(Math.random()*streetsByCity[city].length)]
 return street
}

// MODE NORMAL
function dispatch(){
 routeMode=false
 const street=getRandomStreet()
 hiddenCity=street.city
 currentAddress=street.name+", "+street.city
 result.innerHTML=street.name+"<br><b>"+street.city+"</b>"
 mapBtn.style.display="inline-block"
 answerBtn.style.display="none"
}

function dispatchExam(){
 routeMode=false
 const street=getRandomStreet()
 hiddenCity=street.city
 currentAddress=street.name+", "+street.city
 result.innerHTML=street.name+"<br><i>Ville cachÃ©e</i>"
 mapBtn.style.display="inline-block"
 answerBtn.style.display="inline-block"
}

// MODE JE PARS / JE VAIS
function dispatchRoute(){
 routeMode=true

 let start=getRandomStreet()
 let end=getRandomStreet()
 while(start.name===end.name){ end=getRandomStreet() }

 startAddress=start.name+", "+start.city
 endAddress=end.name+", "+end.city

 result.innerHTML=
 "Je pars de :<br><b>"+start.name+"</b><br>"+start.city+
 "<br><br>Je vais Ã  :<br><b>"+end.name+"</b><br>"+end.city

 mapBtn.style.display="inline-block"
 answerBtn.style.display="none"
}

function showAnswer(){
 if(routeMode){
  result.innerHTML=
   "Je pars de :<br><b>"+startAddress+"</b><br><br>"+
   "Je vais Ã  :<br><b>"+endAddress+"</b>"
 }else{
  result.innerHTML=result.innerHTML.replace("Ville cachÃ©e","<b>"+hiddenCity+"</b>")
 }
}

function openMap(){
 if(routeMode){
  window.open("https://www.google.com/maps/dir/"+encodeURIComponent(startAddress)+"/"+encodeURIComponent(endAddress))
 }else{
  window.open("https://www.google.com/maps/search/"+encodeURIComponent(currentAddress))
 }
}

function showEasterEgg(){ alert("Oisien serait fier de toi fils ðŸ˜Ž") }
</script>
</body>
</html>
