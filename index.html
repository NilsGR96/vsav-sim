<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸš’ Simulation dÃ©part VSAV</title>

<style>
body{
    font-family: Arial;
    background:#0f172a;
    color:white;
    text-align:center;
    padding:20px;
}

button{
    border:none;
    border-radius:12px;
    padding:16px;
    font-size:22px;
    margin:10px;
    width:90%;
    max-width:350px;
}

#dispatchBtn{background:#e11d48;color:white;}
#examBtn{background:#fb923c;color:white;}
#whoPaysBtn{background:#fbbf24;color:white;}
#eliminateBtn{background:#ef4444;color:white;display:none;}
#nextPlayerBtn{background:#3b82f6;color:white;display:none;}
#mapBtn{background:#22c55e;color:white;display:none;}
#answerBtn{background:#3b82f6;color:white;display:none;}

#result{font-size:32px;margin-top:20px}
#timer{font-size:40px;color:#facc15;margin-top:20px}

#loadingBox{
    width:90%;
    max-width:400px;
    height:25px;
    background:#1e293b;
    border-radius:20px;
    margin:20px auto;
    overflow:hidden;
    display:none;
}
#loadingBar{
    height:100%;
    width:0%;
    background:#22c55e;
}
</style>
</head>

<body>

<h1>ğŸš’ Simulation dÃ©part</h1>

<div id="loadingText"></div>
<div id="loadingBox"><div id="loadingBar"></div></div>

<select id="timeSelect">
<option value="0">Pas de chrono</option>
<option value="10">10 sec</option>
<option value="20">20 sec</option>
<option value="30">30 sec</option>
</select>

<br>

<button id="dispatchBtn" disabled onclick="whoPaysMode?dispatchForCurrentPlayer():dispatch()">Ã‡A DÃ‰CALE ğŸš¨</button>
<button id="examBtn" disabled onclick="whoPaysMode?dispatchExamForCurrentPlayer():dispatchExam()">Ã‡A PART DIRECT ğŸš¨</button>
<button id="whoPaysBtn" disabled onclick="startWhoPays()">Qui paye ? ğŸº</button>
<button id="eliminateBtn" onclick="eliminateCurrentPlayer()">Ã‰liminer joueur âŒ</button>
<button id="nextPlayerBtn" onclick="nextPlayerWithoutElimination()">Joueur suivant â¡ï¸</button>

<div id="timer"></div>
<div id="result"></div>

<div>
<button id="mapBtn" onclick="openMap()">Afficher sur la carte</button>
<button id="answerBtn" onclick="showAnswer()">Afficher la ville</button>
</div>

<div onclick="showEasterEgg()" style="position:fixed;bottom:10px;left:10px;font-size:12px;cursor:pointer">ğŸ‘€</div>
<div onclick="localStorage.clear();alert('Cache vidÃ© ğŸ‘ recharge la page');" style="position:fixed;bottom:10px;right:10px;font-size:12px;cursor:pointer">reset cache</div>

<script>
let streetsByCity={}
let currentAddress=""
let hiddenCity=""
let players=[]
let currentPlayerIndex=0
let whoPaysMode=false
let countdownInterval

// ğŸ’¾ stockage local
function saveStreetsToLocal(){
 localStorage.setItem("streetsData",JSON.stringify(streetsByCity))
}
function loadStreetsFromLocal(){
 const data=localStorage.getItem("streetsData")
 if(data){ streetsByCity=JSON.parse(data); return true }
 return false
}

// ğŸ“Š barre chargement
function updateLoading(progress,text){
 document.getElementById("loadingText").innerHTML=text
 document.getElementById("loadingBox").style.display="block"
 document.getElementById("loadingBar").style.width=progress+"%"
}

// ğŸ” rÃ©cupÃ©ration OpenStreetMap
async function fetchCity(city,progress){
 updateLoading(progress,"TÃ©lÃ©chargement rues : "+city+"...")
 const query=`[out:json];area["name"="${city}"]["admin_level"="8"]->.a;(way["highway"]["name"](area.a););out tags;`
 const res=await fetch("https://overpass-api.de/api/interpreter",{method:"POST",body:query})
 const data=await res.json()

 const streets=[...new Set(data.elements.map(e=>e.tags.name)
  .filter(n=>n&&(n.startsWith("Rue")||n.startsWith("Avenue")||n.startsWith("Boulevard")))
  .map(name=>({city,name})))]

 streetsByCity[city]=streets
}

// ğŸš€ INIT
async function init(){

 if(loadStreetsFromLocal()){
  document.getElementById("loadingText").innerHTML="Rues chargÃ©es depuis le tÃ©lÃ©phone ğŸš€"
  enableButtons()
  return
 }

 await fetchCity("Sarcelles",30)
 await fetchCity("Villiers-le-Bel",60)
 await fetchCity("Ã‰couen",90)

 updateLoading(100,"Sauvegarde locale...")
 saveStreetsToLocal()

 setTimeout(()=>{
  document.getElementById("loadingBox").style.display="none"
  document.getElementById("loadingText").innerHTML="Rues prÃªtes ğŸš’"
  enableButtons()
 },800)
}
init()

function enableButtons(){
 dispatchBtn.disabled=false
 examBtn.disabled=false
 whoPaysBtn.disabled=false
}

// ğŸ² tirage
function getRandomStreet(){
 const cities=Object.keys(streetsByCity)
 const city=cities[Math.floor(Math.random()*cities.length)]
 const street=streetsByCity[city][Math.floor(Math.random()*streetsByCity[city].length)]
 hiddenCity=city
 currentAddress=street.name+", "+city
 return street.name
}

function dispatch(){
 const street=getRandomStreet()
 result.innerHTML=street+"<br><b>"+hiddenCity+"</b>"
 mapBtn.style.display="inline-block"
 answerBtn.style.display="none"
}

function dispatchExam(){
 const street=getRandomStreet()
 result.innerHTML=street+"<br><i>Ville cachÃ©e</i>"
 mapBtn.style.display="inline-block"
 answerBtn.style.display="inline-block"
}

function showAnswer(){
 result.innerHTML=result.innerHTML.replace("Ville cachÃ©e","<b>"+hiddenCity+"</b>")
}
function openMap(){
 window.open("https://www.google.com/maps/search/"+encodeURIComponent(currentAddress))
}

// ğŸº mode Qui paye
function startWhoPays(){
 const input=prompt("Participants sÃ©parÃ©s par virgule")
 if(!input)return
 players=input.split(",").map(p=>p.trim())
 whoPaysMode=true
 eliminateBtn.style.display="inline-block"
 nextPlayerBtn.style.display="inline-block"
 result.innerHTML="Tour de "+players[0]
}

function dispatchForCurrentPlayer(){ dispatch(); result.innerHTML+="<br>"+players[currentPlayerIndex] }
function dispatchExamForCurrentPlayer(){ dispatchExam(); result.innerHTML+="<br>"+players[currentPlayerIndex] }

function nextPlayerWithoutElimination(){
 currentPlayerIndex=(currentPlayerIndex+1)%players.length
 result.innerHTML="Tour de "+players[currentPlayerIndex]
}
function eliminateCurrentPlayer(){
 players.splice(currentPlayerIndex,1)
 nextPlayerWithoutElimination()
}

function showEasterEgg(){ alert("Oisien serait fier de toi fils ğŸ˜") }

</script>
</body>
</html>
